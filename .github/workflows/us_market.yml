name: US Market Data Notification

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š6:00æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    # åŒ—äº¬æ—¶é—´æ—©ä¸Š6:00 = UTCæ—¶é—´å‰ä¸€å¤©22:00
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  notify-us-market:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Get US market data and send notification
      env:
        BARK_URL: ${{ secrets.BARK_URL }}
      run: |
        python -c "
import sys
import os
sys.path.append('./src')
from scraper import MarketDataScraper
from bark_notifier import BarkNotifier
from config import Config

try:
    bark_url = os.environ.get('BARK_URL')
    if not bark_url:
        print('âŒ BARK_URLç¯å¢ƒå˜é‡æœªè®¾ç½®')
        sys.exit(1)
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºäº¤æ˜“æ—¥
    if not MarketDataScraper.is_trading_day():
        print('â„¹ï¸ ä»Šå¤©ä¸æ˜¯äº¤æ˜“æ—¥ï¼Œè·³è¿‡æ¨é€')
        sys.exit(0)
    
    # è·å–ç¾è‚¡æ•°æ®
    print('ğŸ“¥ æ­£åœ¨è·å–ç¾è‚¡æ•°æ®...')
    us_data = MarketDataScraper.get_us_market_data(Config.US_INDICES)
    
    if not us_data:
        print('âŒ æœªèƒ½è·å–åˆ°ç¾è‚¡æ•°æ®')
        sys.exit(1)
    
    # æ ¼å¼åŒ–æ•°æ®
    content = MarketDataScraper.format_market_data(us_data, 'us')
    print('ğŸ“„ æ ¼å¼åŒ–åçš„æ•°æ®:')
    print(content)
    
    # å‘é€æ¨é€
    notifier = BarkNotifier(bark_url)
    success = notifier.send_stock_notification(content, 'us')
    
    if success:
        print('âœ… ç¾è‚¡æ•°æ®æ¨é€æˆåŠŸ')
        sys.exit(0)
    else:
        print('âŒ ç¾è‚¡æ•°æ®æ¨é€å¤±è´¥')
        sys.exit(1)
        
except Exception as e:
    print(f'âŒ æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}')
    import traceback
    traceback.print_exc()
    sys.exit(1)
"
